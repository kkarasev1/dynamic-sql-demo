# dynamic-sql-demo
Демонстрация формирования динамических SQL-запросов с помощью шаблонов Thymeleaf

# Использование механизма текстовых шаблонов Тhymeleaf для формирования динамических SQL-запросов 
(Константин Карасёв, Integrity Solutions)

Как правило, веб-приложение на Java состоит из фронтенда, выполняемого в браузере клиента, среднего слоя, написанного на JavaEE, и базы данных. Значительную часть функционала обычно переносят из среднего слоя — во фронт-энд (рендеринг страниц, валидация форм...) или в базу данных (чему помогают поддержка транзакций и прочие преимущества БД; особенно это касается поиска, статистики, отчётов, когда один запрос затрагивает вплоть до всего содержимого базы), самому́  среднему слою остаётся не так много, его основная задача — сформировать по пришедшему HTTP-запросу запрос в базу данных, переработать его результат в объекты и отдать фронт-энду. Spring MVC (или другой контейнер) хорошо справляется с задачей преобразовать HTTP-запрос в объекты; мы рассмотрим следующую задачу: преобразовать объекты в текст SQL-запроса. 

Есть различные решения этой задачи. Можно использовать статические, даже параметризуемые запросы, но попытки сделать запрос сколь-либо универсальным (например,  предусмотреть, была ли пользователем задана фильтрация по какому-то полю или нет) приводят к его переусложнению. Нужны динамические запросы, меняющиеся в зависимости от входного объекта. Стандартные средства, такие как CriteriaQuery в JPA очень хороши, их стоит применять, когда они работают, но во многих проектах использовать их невозможно по разным причинам — сложные условия запросов, сложные принципы хранения данных (с использованием, например, JSON, нескольких связанных таблиц, TSV-индексов в PostgeSQL) и так далее. Можно формировать запросы с помощью, например, StringBuilder; однако есть более эффективный подход.

Мы будем формировать динамические SQL-запросы с помощью шаблонов Thymeleaf. Механизм шаблонов Thymeleaf существует уже более 9 лет и поддерживает всё, что необходимо для формирования текстов на основе объектов: получение полей объекта, вызов методов, условия, итерации. Вложенные фрагменты шаблонов позволят нам формировать несколько родственных друг другу шаблонов запросов — например, запрос для подсчёта числа элементов и для получения страницы списка элементов, запросы для разных форматов вывода при поддержке одних критериев и так далее. Вспомогательный объект для итерации помогает решить проблему «последней запятой» — вывести список фрагментов с разделителями между элементами, но не после последнего и не перед первым.

Использование шаблонов для формирования динамических запросов требует совсем немногих вспомогательных классов: сервиса, который для получения запросов будет вызывать один из ресолверов, получающих шаблон по имени  (например, ClassLoaderTemplateResolver для шаблонов, хранящихся в ресурсе проекта), и, например, нескольких списков полей для объекта.
Другие применения шаблонов Thymeleaf включают в себя формирование email-сообщений и html-страниц на сервере — последнее считается устаревшим, но имеет свои преимущества.

# Описанный подход был успешно применён автором в проекте «Ситуационный Центр Почты России». 
